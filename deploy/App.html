<!DOCTYPE html>
<html>
<head>
    <title>S838717-ActiveStoriesByOwner</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_projectStore:void 0,_iterationId:void 0,_iterationName:void 0,_filterProject:void 0,_featureState:void 0,_localInitiatives:void 0,_localFeatures:void 0,_localStories:void 0,_localDefects:void 0,_localTestSets:void 0,_userList:void 0,_filterUserList:void 0,_dialogModal:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var t=this.getContext().getProject().ObjectID;this._projectId=t,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this._buildFilter()},_buildFilter:function(){var t=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Iteration:",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(t){console.log("combo ready:",t),t.select(" "),console.log("iteration",this._iterationName)},select:function(t,e){var o=e[0];this._iterationId=o.get("ObjectID"),this._iterationName=o.get("Name"),console.log("iteration",this._iterationName)},scope:this}}),e={xtype:"rallyfieldvaluecombobox",fieldLabel:"Feature States:",id:"statesComboBox",noEntryText:"All",useNullForNoEntryValue:!0,multiSelect:!0,model:"PortfolioItem/Feature",field:"State",scope:this,listeners:{change:function(t){console.log("Feature State: ",t.lastSelection),this._featureState=t.lastSelection},scope:this}},o=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Choose filter:",flex:3,bodyPadding:10,align:"stretch",autoHeight:!0,items:[{xtype:"rallymultiprojectpicker",fieldLabel:"Project",width:350,margin:"10 0 5 0",listeners:{selectionchange:function(t,e){console.log("project combo: ",e),this._filterProject=[],_.each(e,function(t){this._filterProject.push(t.get("ObjectID"))},this)},scope:this}},t,e,o]}]}])},_doSearch:function(){!this._filterProject||this._filterProject.length<1||(this.down("#bodyContainer").removeAll(),this.myMask.show(),this._loadInitiatives().then({success:function(t){return console.log("initiatives:",t),this._localInitiatives=t,this._loadFeatures()},scope:this}).then({success:function(t){return console.log("features:",t),this._localFeatures=t,this._loadStories()},scope:this}).then({success:function(t){return console.log("stories:",t),this._localStories=t,this._loadDefects()},scope:this}).then({success:function(t){return console.log("defects:",t),this._localDefects=t,this._loadTestSets()},scope:this}).then({success:function(t){console.log("testSets:",t),this._localTestSets=t,this._showGrid()},scope:this}))},_getFilters:function(){var t=Ext.create("Rally.data.QueryFilter",{property:"Blocked",operator:"=",value:!1}),e=void 0;return console.log("all projects:",this._filterProject),console.log("local projects:",this._filterProject.length),_.each(this._filterProject,function(t){if(console.log("project:",t),1===this._filterProject.length&&(e=Ext.create("Rally.data.QueryFilter",{property:"Project",operator:"=",value:"/project/"+t})),this._filterProject.length>1&&e){var o=Ext.create("Rally.data.QueryFilter",{property:"Project",operator:"=",value:"/project/"+t});e=e.or(o)}else e=Ext.create("Rally.data.QueryFilter",{property:"Project",operator:"=",value:"/project/"+t})},this),t.and(e)},_getIterationFilter:function(){return Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:this._iterationName})},_getStateFilter:function(t){var e=t,o=[];if(_.each(this._featureState,function(t){console.log("state filter",t.get("name")),"-- No Entry --"!==t.get("name")&&o.push(t.get("name"))},this),o.length>0){var i=Ext.create("Rally.data.QueryFilter",{property:"State",operator:"in",value:o});e=t.and(i)}return e},_showUserFilter:function(){var t=Ext.create("Rally.ui.Button",{text:"Proceed",margin:"10 10 10 10",scope:this,handler:function(){this._filterGrid(),Ext.ComponentQuery.query("#filterUserDialog")[0].hide()}}),e=Ext.create("Rally.ui.Button",{text:"Back",margin:"10 10 10 10",scope:this,handler:function(){Ext.ComponentQuery.query("#filterUserDialog")[0].hide()}}),o=Ext.create("Ext.container.Container",{itemId:"panelButtons",width:500,layout:{type:"hbox"},items:[e,t]}),i=this._buildUserCheckBoxList();console.log("userList",i);var r=Ext.create("Ext.container.Container",{itemId:"panelUsers",width:400,height:400,autoScroll:!0,layout:{type:"vbox"},items:[{xtype:"checkboxgroup",listeners:{change:function(t,e,o,i){console.log("filter selected:",e.userName),this._filterUserList=e.userName},scope:this},columns:1,vertical:!0,items:i}]});this._dialogModal||(this._dialogModal=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,closeAction:"hide",closable:!0,itemId:"filterUserDialog",width:500,title:"Available Users to filter",items:[{xtype:"component",html:"Select users to proceed",padding:10},r,o]})),this._dialogModal.show()},_buildUserCheckBoxList:function(){var t=[];return _.each(this._userList,function(e){t.push({boxLabel:e,name:"userName",inputValue:e})},this),t},_filterGrid:function(){var t=Ext.ComponentQuery.query("#activeStoriesGrid")[0];console.log("filter these users:",this._filterUserList),t.store.clearFilter(!0),this._filterUserList&&t.store.filterBy(function(t,e){return-1!=this._filterUserList.indexOf(t.get("Owner"))},this)},_showGrid:function(){console.log("creating grid for:",t);var t=this._createStore();this._showUserFilter();var e=Ext.create("Rally.ui.grid.Grid",{itemId:"activeStoriesGrid",viewConfig:{stripeRows:!0,enableTextSelection:!0},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,store:t,columnCfgs:[{text:"Owner",dataIndex:"Owner",flex:3},{text:"Initiatives",dataIndex:"Initiatives",flex:2},{text:"Features",dataIndex:"Features",flex:2},{text:"Stories",dataIndex:"Stories",flex:2},{text:"Defects",dataIndex:"Defects",flex:2},{text:"TestSets",dataIndex:"TestSets",flex:2},{text:"Total",dataIndex:"Total",flex:2}]});this.down("#bodyContainer").add(e),this.myMask.hide(),this._filterUserList=void 0},_createStore:function(){var t=[],e=new Ext.util.MixedCollection,o=_.flatten([this._localInitiatives,this._localFeatures,this._localStories,this._localDefects,this._localTestSets]);console.log("all",o),_.each(o,function(t){var o,i=t.get("Owner");if(o=i?i._refObjectName:"None",e.containsKey(o))e.get(o).push(t);else{var r=[];r.push(t),e.add(o,r)}},this),console.log("map",e),this._userList=[],e.eachKey(function(e,o){this._userList.push(e);var i=0,r=0,a=0,l=0,s=0,n=o.length;_.each(o,function(t){var e=t.get("_type");"portfolioitem/initiative"===e?i+=1:"portfolioitem/feature"===e?r+=1:"hierarchicalrequirement"===e?a+=1:"defect"===e?l+=1:"testset"===e&&(s+=1)},this);var c={Owner:e,Initiatives:i,Features:r,Stories:a,Defects:l,TestSets:s,Total:n};t.push(c)},this);var i=Ext.create("Ext.data.JsonStore",{fields:["Owner","Initiatives","Features","Stories","Defects","TestSets","Total"]});return i.loadData(t),i},_loadInitiatives:function(){var t=this._getFilters();return t=this._getStateFilter(t),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Initiative"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:t,limit:1/0}).load()},_loadFeatures:function(){var t=this._getFilters();return t=this._getStateFilter(t),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:t,limit:1/0}).load()},_loadStories:function(){var t=this._getFilters();return this._iterationName&&"-- Clear --"!==this._iterationName&&(t=t.and(this._getIterationFilter()),console.log("iter filter",this._iterationName),console.log("iter filter string",t.toString())),console.log("filter",t),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["HierarchicalRequirement"],fetch:["FormattedID","Name","ObjectID","Project","ScheduleState","Owner","Iteration"],filters:t,limit:1/0}).load()},_loadDefects:function(){var t=this._getFilters();return this._iterationName&&"-- Clear --"!==this._iterationName&&(t=t.and(this._getIterationFilter())),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["Defect"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:t,limit:1/0}).load()},_loadTestSets:function(){var t=this._getFilters();return"-- Clear --"!==this._iterationName&&(t=t.and(this._getIterationFilter())),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["TestSet"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:t,limit:1/0}).load()}});

            Rally.launchApp('CustomApp', {
                name:"S838717-ActiveStoriesByOwner",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
