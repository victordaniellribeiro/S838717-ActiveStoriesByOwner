<!DOCTYPE html>
<html>
<head>
    <title>S838717-ActiveStoriesByOwner</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_projectStore:void 0,_filterProject:void 0,_featureState:void 0,_localInitiatives:void 0,_localFeatures:void 0,_localStories:void 0,_localDefects:void 0,_localTestSets:void 0,_userStore:void 0,_usersSearch:void 0,_userList:void 0,_filterUserList:void 0,_dialogModal:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this._projectId=e,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:200,fetch:["Editors"],autoLoad:!0,filters:[{property:"ObjectID",operator:"=",value:this._projectId}],listeners:{load:function(e,t,o){console.log("users",e,t);var i=t[0],r=i.get("Editors");r.Count;console.log("loading Editors",r),i.getCollection("Editors").load({fetch:["_refObjectName","Name","ObjectID","DisplayName","UserName","Deleted","Disabled"],limit:500,filters:[{property:"Disabled",operator:"=",value:!1},{property:"Deleted",operator:"=",value:!1}],callback:function(t,o,i){console.log("Editors loaded",t),Ext.Array.each(t,function(e){});var r=Ext.create("Rally.data.wsapi.artifact.Store",{models:["User"]});r.loadData(t),this._userStore=r,e.remoteFilter=!1,this._buildFilter()},scope:this})},scope:this}})},_buildFilter:function(){var e={xtype:"rallyfieldvaluecombobox",fieldLabel:"Feature States:",id:"statesComboBox",noEntryText:"All",useNullForNoEntryValue:!0,multiSelect:!0,model:"PortfolioItem/Feature",field:"State",scope:this,listeners:{change:function(e){console.log("Feature State: ",e.lastSelection),this._featureState=e.lastSelection},scope:this}},t={xtype:"rallymultiobjectpicker",fieldLabel:"Pre Select Users:",modelType:"user",filterFieldName:"_refObjectName",width:400,stateid:this.getContext().getScopedStateId("preUsers"),_refreshStore:function(){var e;return this.store?(this.store.requester=this,e=this.store.getCount()<1?this.store.load(this.storeLoadOptions):Deft.Promise.when(this.store.data)):e=this.createStore().then({success:function(){return this.store.load(this.storeLoadOptions)},scope:this}),e.then({success:this._onStoreLoaded,scope:this})},_onStoreLoaded:function(){if(this.allowNoEntry&&!(this.store.count()>0&&this.store.findRecord(this.listCfg.displayField,this.noEntryText))){var e=Ext.create(this.store.model);e.set(this.listCfg.displayField,this.noEntryText),e.set(this.selectionKey,null),e.set(this.recordKey,0),this.store.insert(0,e)}},store:this._userStore,storeConfig:{pageSize:200,fetch:["_refObjectName","Name","ObjectID","DisplayName","UserName","Disabled"],remoteFilter:!1,remoteGroup:!1,remoteSort:!1,limit:1e3,sorters:[{property:"_refObjectName",direction:"ASC"}]},listCfg:{displayField:"_refObjectName"},listeners:{selectionchange:function(e,t){console.log("combo: ",e),console.log("combo: ",t),e.refreshView(),this._usersSearch=t},scope:this}},o=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch(),this.saveState()}});this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Choose filter:",flex:3,bodyPadding:10,align:"stretch",autoHeight:!0,items:[{xtype:"rallymultiprojectpicker",fieldLabel:"Project",width:350,margin:"10 0 5 0",listeners:{selectionchange:function(e,t){console.log("project combo: ",t),this._filterProject=[],_.each(t,function(e){this._filterProject.push(e.get("ObjectID"))},this)},scope:this}},e,t,o]}]}])},_doSearch:function(){!this._filterProject||this._filterProject.length<1||(this.down("#bodyContainer").removeAll(),this.myMask.show(),this._loadInitiatives().then({success:function(e){return console.log("initiatives:",e),this._localInitiatives=e,this._loadFeatures()},scope:this}).then({success:function(e){return console.log("features:",e),this._localFeatures=e,this._loadStories()},scope:this}).then({success:function(e){return console.log("stories:",e),this._localStories=e,this._loadDefects()},scope:this}).then({success:function(e){return console.log("defects:",e),this._localDefects=e,this._loadTestSets()},scope:this}).then({success:function(e){console.log("testSets:",e),this._localTestSets=e,this._showGrid()},scope:this}))},_getProjectFilter:function(e){return Ext.create("Rally.data.QueryFilter",{property:"Project",operator:"=",value:"/project/"+e}).or(Ext.create("Rally.data.QueryFilter",{property:"Project.parent",operator:"=",value:"/project/"+e}).or(Ext.create("Rally.data.QueryFilter",{property:"Project.parent.parent",operator:"=",value:"/project/"+e})))},_getFilters:function(){var e,t=Ext.create("Rally.data.QueryFilter",{property:"Blocked",operator:"=",value:!1});if(this._usersSearch&&this._usersSearch.length>0){var o=[];_.each(this._usersSearch,function(e){o.push(e.get("ObjectID"))},this),console.log("ids for searching",o),e=Ext.create("Rally.data.QueryFilter",{property:"Owner.ObjectID",operator:"in",value:[o]})}var i=void 0;return console.log("all projects:",this._filterProject),console.log("local projects:",this._filterProject.length),_.each(this._filterProject,function(e){if(console.log("project:",e),1===this._filterProject.length&&(i=this._getProjectFilter(e)),this._filterProject.length>1&&i){var t=this._getProjectFilter(e);i=i.or(t)}else i=this._getProjectFilter(e)},this),e?e.and(t.and(i)):t.and(i)},_getStateFilter:function(e){var t=e,o=[];if(_.each(this._featureState,function(e){console.log("state filter",e.get("name")),"-- No Entry --"!==e.get("name")&&o.push(e.get("name"))},this),o.length>0){var i=Ext.create("Rally.data.QueryFilter",{property:"State",operator:"in",value:o});t=e.and(i)}return t},_showUserFilter:function(){var e=Ext.create("Rally.ui.Button",{text:"Proceed",margin:"10 10 10 10",scope:this,handler:function(){this._filterGrid(),Ext.ComponentQuery.query("#filterUserDialog")[0].hide()}}),t=Ext.create("Rally.ui.Button",{text:"Back",margin:"10 10 10 10",scope:this,handler:function(){Ext.ComponentQuery.query("#filterUserDialog")[0].hide()}}),o=Ext.create("Ext.container.Container",{itemId:"panelButtons",width:400,layout:{type:"hbox"},items:[t,e]}),i=this._buildUserCheckBoxList();console.log("userList",i);var r=Ext.create("Ext.container.Container",{itemId:"panelUsers",width:350,height:190,autoScroll:!0,layout:{type:"vbox"},items:[{xtype:"checkboxgroup",listeners:{change:function(e,t,o,i){console.log("filter selected:",t.userName),this._filterUserList=t.userName},scope:this},columns:1,vertical:!0,items:i}]});this._dialogModal?(this._dialogModal.destroy(),this._dialogModal=this._createModal(r,o)):this._dialogModal=this._createModal(r,o),this._dialogModal.show()},_createModal:function(e,t){return Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,closeAction:"hide",closable:!0,itemId:"filterUserDialog",width:410,height:310,title:"Available Users to filter",items:[{xtype:"component",html:"Select users to proceed",padding:10},e,t]})},_buildUserCheckBoxList:function(){var e=[];return _.each(this._userList,function(t){e.push({boxLabel:t,name:"userName",inputValue:t})},this),e},_filterGrid:function(){var e=Ext.ComponentQuery.query("#activeStoriesGrid")[0];console.log("filter these users:",this._filterUserList),e.store.clearFilter(!0),this._filterUserList&&e.store.filterBy(function(e,t){return-1!==this._filterUserList.indexOf(e.get("Owner"))},this)},_showGrid:function(){console.log("creating grid for:",e);var e=this._createStore();this._showUserFilter();var t=Ext.create("Rally.ui.grid.Grid",{itemId:"activeStoriesGrid",viewConfig:{stripeRows:!0,enableTextSelection:!0},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,store:e,columnCfgs:[{text:"Owner",dataIndex:"Owner",flex:3},{text:"Initiatives",dataIndex:"Initiatives",flex:2},{text:"Features",dataIndex:"Features",flex:2},{text:"Stories",dataIndex:"Stories",flex:2},{text:"Defects",dataIndex:"Defects",flex:2},{text:"TestSets",dataIndex:"TestSets",flex:2},{text:"Total",dataIndex:"Total",flex:2}]});this.down("#bodyContainer").add(t),this.myMask.hide(),this._filterUserList=void 0},_createStore:function(){var e=[],t=new Ext.util.MixedCollection,o=_.flatten([this._localInitiatives,this._localFeatures,this._localStories,this._localDefects,this._localTestSets]);console.log("all",o),_.each(o,function(e){var o,i=e.get("Owner");if(o=i?i._refObjectName:"None",t.containsKey(o))t.get(o).push(e);else{var r=[];r.push(e),t.add(o,r)}},this),console.log("map",t),this._userList=[],t.eachKey(function(t,o){this._userList.push(t);var i=0,r=0,s=0,a=0,l=0,c=o.length;_.each(o,function(e){var t=e.get("_type");"portfolioitem/initiative"===t?i+=1:"portfolioitem/feature"===t?r+=1:"hierarchicalrequirement"===t?s+=1:"defect"===t?a+=1:"testset"===t&&(l+=1)},this);var n={Owner:t,Initiatives:i,Features:r,Stories:s,Defects:a,TestSets:l,Total:c};e.push(n)},this),console.log("User list for modal:",this._userList);var i=Ext.create("Ext.data.JsonStore",{fields:["Owner","Initiatives","Features","Stories","Defects","TestSets","Total"]});return i.loadData(e),i},_loadInitiatives:function(){var e=this._getFilters();return e=this._getStateFilter(e),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Initiative"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:e,limit:1/0}).load()},_loadFeatures:function(){var e=this._getFilters();return e=this._getStateFilter(e),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:e,limit:1/0}).load()},_loadStories:function(){var e=this._getFilters();return console.log("filter",e),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["HierarchicalRequirement"],fetch:["FormattedID","Name","ObjectID","Project","ScheduleState","Owner","Iteration"],filters:e,limit:1/0}).load()},_loadDefects:function(){var e=this._getFilters();return Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["Defect"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:e,limit:1/0}).load()},_loadTestSets:function(){var e=this._getFilters();return Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["TestSet"],fetch:["FormattedID","Name","ObjectID","Project","State","Owner"],filters:e,limit:1/0}).load()}});

            Rally.launchApp('CustomApp', {
                name:"S838717-ActiveStoriesByOwner",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
